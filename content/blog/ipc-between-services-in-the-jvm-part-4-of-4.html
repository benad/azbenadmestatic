---toml
title = "IPC between services in the JVM: Part 4 of 4"
date = "2010-08-17T14:03:00-04:00"
permalink = "blog/2010/8/17/ipc-between-services-in-the-jvm-part-4-of-4/"
---

<div class="posterous_autopost"><p><strong>Message Queues</strong></p>  <p>The approach I settled for is one that uses message queues between the OSGi services. This is roughly the equivalent of inter-process message queues in UNIX System V or file sockets in BSD.</p>  <p>When the messages themselves are immutable objects, this avoids almost all potential race conditions and deadlocks caused by shared objects. Even when using non-blocking queues, the simple matter of copying/moving large amount of objects (or, worse, using any form of object serialization) makes this much slower than using shared memory. If the message objects are big, then it may be better to avoid serialization and take the risk of having two services refer to the same object at the same time.</p>  <p>As for what library to use to implement those queues, there are many high-performance libraries to choose from, though few of these have a way of running in &ldquo;embedded mode&rdquo; within the same JVM that runs the OSGi container.</p>  <p>There&rsquo;s a way of running <a href="https://mq.dev.java.net/">Open Message Queues for Java</a>, which can <a href="https://mq.dev.java.net/4.4-content/embedded-example.html">run in embedded mode</a>, but it&rsquo;s quite big, complex and &ldquo;Enterprise-y&rdquo;. There&rsquo;s also <a href="http://github.com/robey/kestrel">Kestrel</a>, a minimalist small implementation, and can also <a href="http://github.com/robey/kestrel/blob/master/docs/guide.md">run in embedded mode</a>, but then it needs <a href="http://www.scala-lang.org/">Scala</a> which I won&rsquo;t even try running within an OSGi module.</p>  <p>But these library are <em>network</em>-oriented, which not only makes their implementation more complex but also slower in the special case when all the messages remains in the same JVM. So, in the end, I just used the Java 5 built-in <code>java.util.concurrent.BlockingQueue</code> and made my own simple message passing interface around it.</p></div>
